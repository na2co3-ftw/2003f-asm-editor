# 2003f Editor 詳細仕様

## 2003fインタプリタ
参照元: [Haskell Interpreter版](https://github.com/jurliyuuri/OS/tree/master/assembler)

### 追加した実行時警告
* 4バイトでアラインメントされていないメモリアクセス
* 64以上のビットシフト

## 2003lk
参照元: [Haskell Interpreter版](https://github.com/jurliyuuri/OS/tree/master/assembler)

### 仕様変更
* U+2028, U+2029, U+FEFF も空白文字として扱う (Haskellの `isSpace` と JSの `/\s/` の差)
* `krz8i` (8ビットロード)、 `krz8c` (8ビットストア)、 `krz16i` (16ビットロード)、 `krz16c` (16ビットストア) を試験実装

### 追加した警告
* `fi` の直後に `malkrz` がない時
* `malkrz` が `fi` の直後にない時
* `malkrz` にラベルを付けた時
* 命令よりも先に、 `'c'i` または `'i'c` のどちらかが明示的に指定されていない時
* `l'` 、 `nll` または `xok` によるラベル定義で、ラベル名がキーワード名(`kak` 含)と重複する時
* `l'` の直前が命令ではない(`'c'i` 等の)時
* `nll` の直後が命令ではない時
* 定義されたラベルが、一度も使用されていない時
* `inj f0 f1 f1@` や同様の `lat` `latsna` での未定義動作を書いた時
* (未実装) `kue` されたラベルが、他ファイルで一度も使用されていない時

## tinka
参照元: [Kotlin版](https://github.com/Nobuyuki-Tokuchi/tinka)

### 仕様変更
* U+FEFF も空白文字として扱う。 U+001C-U+001F は空白文字として扱わない (Kotlinの `Char.isWhitespace` と JSの `/\s/` の差)

### 追加した警告
* 変数宣言で、変数名が数字の時: `anax 1`
* 変数宣言で、変数名が `kue` 、 `xok` または `fi` の時: `anax fi`
* 変数宣言で、変数名が `/[FRVXa-z0-9'_-]+/` に一致しない時: `anax あ`
* 変数宣言で、配列のサイズが `+` か `-` で始まる時: `anax p@+10`
* 変数宣言で、@が2つ以上含まれる時: `anax p@10@2` (`p@10` として解釈される)
* 変数宣言が、関数の中で先頭ではない時
* 変数名が重複している時: `anax p anax p`
* 配列として宣言された変数を通常の変数として使用した時
* 通常の変数として宣言されたものを配列として使用した時
* `xok` で指定したラベル名が数字で始まる時、キーワードと重複する時、または `/^(fi|fal(-rinyv)?|dosnud)\d+$/` に一致する時: `xok krz`
* 関数名が、キーワードと重複する時、または `/^(fi|fal(-rinyv)?|dosnud)\d+$/` に一致する時: `cersva krz`
* 関数の引数名がキーワードと重複する時: `cersva p krz`
* `_fasal` 関数が引数を持つ時: `cersva _fasal p`
* 関数の引数名が重複している時: `cersva p F F`
* 関数呼出や `xok` で内部ラベル(`dosnud1` など)を使用した時
* 関数呼出で与える引数の数が関数宣言と一致しない時
* ファイル終端の直前にトークンがある時 (本家ではトークンの後に空白またはコメントを挟まずにファイル終端があると、その命令が無視される)
* (未実装) 値を返さない関数の返り値を使用しようとした時

重要度の低いもの
* 宣言された変数または引数が、一度も使用されていない時
* 宣言された関数または `xok` で指定したラベルが、一度も使用されていない時
* `rinyv` 〜 `situv` の間に何もない時: `rinyv situv`
* (未実装) `kue` されたラベルが、他ファイルで一度も使用されていない時

### 追加したエラー
* 変数宣言で、配列のサイズが数字ではない時: `anax p@F` (本家ではjava.lang.NumberFormatExceptionになる)
* 宣言されていない変数を使用した時 (本家ではkotlin.KotlinNullPointerExceptionになる)
* 関数宣言または `xok` で指定されたラベルが、内部ラベルと重複した時 (本家では2003lkパーサがラベル重複定義エラーを吐く)

## cent
参照元: [C#版](https://github.com/Nobuyuki-Tokuchi/Cent)

### 仕様変更
* `malef` `felam` による2003lk埋め込みは未実装
* U+FEFF も空白文字として扱う。 U+0085 は空白文字として扱わない (C#の `Char.IsWhiteSpace` と JSの `/\s/` の差)

### 追加した警告
* サブルーチン名が `/[^FRVXa-z0-9,.?!':+|=$\\@&#"()《》_-]/` を含む時
* `xok`で指定された関数名が `/^(fal|laf|ol|if|cecio|oicec|leles-niv|leles-situv)\d+$/` に一致する時
* `fi` 〜 `if` 、 `cecio` 〜 `oicec` 、 `fal` 〜 `laf` 内でサブルーチンまたは `xok` を宣言した時
* サブルーチン名と `xok` で指定された関数名が重複した時
* 重複した名前のサブルーチンを定義し、それが1度も呼ばれていない時
* ファイル終端の直前にトークン(`<` `>` を除く)がある時 (本家ではトークンの後に空白、コメント、 `<` `>` のいずれも挟まずにファイル終端があると、その命令が無視される)

重要度の低いもの
* サブルーチンの中が空の時: `<p>`
* `fi` 〜 `if` または `ol` 、 `ol` 〜 `if` 、 `cecio` 〜 `oicec` 、 `fal` 〜 `laf` の間に何もない時
* 定義されたサブルーチンまたは `xok` で指定した関数が、一度も使用されていない時

### 追加したエラー
* `xok` で指定されたラベルが、内部ラベルと重複した時 (本家では2003lkパーサがラベル重複定義エラーを吐く)

## ata2003lk
参照元: [Lua版](https://github.com/Nobuyuki-Tokuchi/ata2003lk)

Lua版は2003lkへのトランスパイラとして実装されているが、2003f Editorでは2003lkのパーサを拡張して実装する方針にしたため、詳細仕様が大きく変更になった

### 仕様変更
* U+0012, U+0013, U+00A0, U+1680, U+2000-U+200A, U+2028, U+2029, U+202F, U+205F, U+3000, U+FEFF も空白文字として扱う。 (JSの `/\s/`)
* コメントはトークンの境界とする (本家では `kr;;z` は `krz` として解釈されるが、`kr z` とするように変更)
* トークンの後に、空白を挟まないかコメントのみを挟んで、ファイル終端があるとき、そのトークンが無視されないように
* `@`の直後をトークンの境界とする (本家では `krz f0 f1@ycax` とすると `ycax` が処理されない)
* ata2003lk命令でオペランドに空白を含むことを許す `zali f0 @`
* スタックの参照で空白を含むことを許す `s @ 1`
* `'c'i` `'i'c` の使用を禁止 (ラベル名としては使用可能)
* オペランドやラベル名の場所で `zali` `ycax` `cers` `dosn` `lar` `ral` をラベルとして解釈する
* `krz8i` (8ビットロード)、 `krz8c` (8ビットストア)、 `krz16i` (16ビットロード)、 `krz16c` (16ビットストア) を試験実装

### 追加した警告
* `fi` の直後に `malkrz` がない時
* `malkrz` が `fi` の直後にない時
* `malkrz` にラベルを付けた時
* `l'` 、 `nll` または `xok` によるラベル定義で、ラベル名がキーワード名(`kak` 含、 `'i'c` 、 `'c'i` 含まない)または `/^(lar(-sit)?)\d+$/` を含む時
* `l'` の直前が命令ではない(`'c'i` 等の)時
* `nll` の直後が命令ではない時
* `lar` と `ral` の対応関係が一致しない時 (ラベル未定義を引き起す場合はエラー、そうでない場合は警告)
* 内部ラベル(`lar1` など)を使用した時
* 定義されたラベルが、一度も使用されていない時
* `inj f0 f1 f1@` や同様の `lat` `latsna` での未定義動作を書いた時
* (未実装) `kue` されたラベルが、他ファイルで一度も使用されていない時
